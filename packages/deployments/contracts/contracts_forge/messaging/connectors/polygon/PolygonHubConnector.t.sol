// SPDX-License-Identifier: MIT OR Apache-2.0
pragma solidity 0.8.17;

import "@openzeppelin/contracts/crosschain/errors.sol";

import {IRootManager} from "../../../../contracts/messaging/interfaces/IRootManager.sol";

import {IFxStateSender, ICheckpointManager} from "../../../../contracts/messaging/connectors/polygon/tunnel/FxBaseRootTunnel.sol";
import {PolygonHubConnector} from "../../../../contracts/messaging/connectors/polygon/PolygonHubConnector.sol";
import {RLPReader} from "../../../../contracts/messaging/connectors/polygon/lib/RLPReader.sol";
import {TypeCasts} from "../../../../contracts/shared/libraries/TypeCasts.sol";

import "../../../utils/ConnectorHelper.sol";
import "../../../utils/Mock.sol";

contract ICheckpointManagerTest is ICheckpointManager {
  function setHeaderBlocks(uint256 key, HeaderBlock memory value) public {
    headerBlocks[key] = value;
  }
}

contract PolygonHubConnectorTarget is PolygonHubConnector {
  constructor(
    uint32 _domain,
    uint32 _mirrorDomain,
    address _amb,
    address _rootManager,
    address _mirrorConnector,
    address _checkPointManager
  ) PolygonHubConnector(_domain, _mirrorDomain, _amb, _rootManager, _mirrorConnector, _checkPointManager) {}

  function markAsProcessed(bytes32 _root) public {
    processedMessageRoots[_root] = true;
  }
}

library SampleTransaction {
  // this transaction is a spoke -> hub connector with a root:
  // https://etherscan.io/tx/0x7591fc43602f8f5916ee535d44ed0f14fdff441c8e2f85e8fe37e18ead7b6e66

  // root: 0xf13ac1d04c41ca8349344610c9a148a7d1a29be208282d5e98e56dfa99b38fdb
  bytes32 public constant root = 0xf13ac1d04c41ca8349344610c9a148a7d1a29be208282d5e98e56dfa99b38fdb;

  // RLP encoded data from above tx
  bytes public constant data =
    hex"f91b2684209585b0b90180e8b8326c64770be3d48f7bdcf57ec2e7d4fd8dc0673babf446ebb16fc88c87384331a6a068b0653a25cad192b3796639ee804670f6ce36270ccc371aac263834798d0a38d405124e0f22f9ca67a0d8dffd0200b4ae393a1c29fd9db3b629e66005e3ed6bcd657881b80dce78815d9071920dc1293d890743ef225eed10f4b5602111fc8b9331c588bc54e8de7deff131802e755413ba318a89f4b9770e38a6a7543f69f309de50279d6e105bf5ee163192f2fdb134927a27e974c833af10b8105ee2b03cfc2798d78d8317bcf53dab980d6622c9d7ad6ec4024381baa797bf784fadcce9b5d14c987a6fb1e21b08f2dd01afc77891931405e32c1b7fabeab29bf1ded26b9dd5c5b9b2aa99cec5b2be6a779ec8e25611557db07e726b1cddfcc7cc5ccd5f601dfba23ed70fb61c4207de20ddfd5c96a19482885c880b5cc044375bed3ae7eeb7a8543cca0a3ebe52e4de3ff7faff86462b5074fce6a4c6a660f4131ee8dfe7b43b9c34bc9e87da5f51e50dede4bb980689d02b0555c465628c2c84030815a08465721cdea02a49c5bddb7d04d2a8557498e0b678450101cf9c9d8b1c57f82d011348c6f237a0b642abb55f8b10512f4b1afb8420409d0b16b9bae76ec32a627b311637b523acb90a3702f90a3301838daca5b9010000004000000000000408000000000000000000000000400000000000000000412000000000000200000088002000000000008000000000000000000000000000000010000000000800000000000080800000000040400040000100000000000000000000040000001000040000000001000000100040000080000000000000000000000000400000000000040800000020400000000400000000000000000100204000000000080000800040800000000008000000000000000000000000004000000000000000080481000040000000040000000000000000100000001000000000000000000001000002800000000400000000000000000000000420104001f90928f8999496fddc1a6fbdb232e9ada1ffc1026799f85128e9e1a08c5261668696ce22758910d05bab8f186d6eb247ceac2af2e82c7dc17669b036b86000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020f13ac1d04c41ca8349344610c9a148a7d1a29be208282d5e98e56dfa99b38fdbf8f99496fddc1a6fbdb232e9ada1ffc1026799f85128e9e1a0dcaa37a042a0087de79018c629bbd29cee82ca80bd9be394e1696bf9e9355077b8c0000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000088483b3e3b4dd7cedb8efcef81f6dc9adb6292d50000000000000000000000000000000000000000000000000000000000000020f13ac1d04c41ca8349344610c9a148a7d1a29be208282d5e98e56dfa99b38fdb0000000000000000000000000000000000000000000000000000000000000000f8799488483b3e3b4dd7cedb8efcef81f6dc9adb6292d5e1a09826a73d0fd7186bda6a15195ac17571869cab151bfe9a8fed3f9407fffe5b18b84000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000923d663c88ce81fdb5f87a940970adeb473609f91d03e9bba85f49c445040cd7f842a03d0ce9bfc3ed7d6862dbb28b2dea94561fe714a1b4d019aa8af39730d1ad7c3da000000000000000000000000088483b3e3b4dd7cedb8efcef81f6dc9adb6292d5a00000000000000000000000000000000000000000000000000000000000000000f8799488483b3e3b4dd7cedb8efcef81f6dc9adb6292d5e1a09826a73d0fd7186bda6a15195ac17571869cab151bfe9a8fed3f9407fffe5b18b84000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000923d663c88ce81fdb5f9011d9475ba5af8effdcfca32e1e288806d54277d1fde99f884a0116bfd46451bbd23e7a5f5b7420b28e3d98d4c477f173da513aaaeac3c4baadaa0000000000000000000000000ade09131c6f43fe22c2cbabb759636c43cfc181ea000000000000000000000000088483b3e3b4dd7cedb8efcef81f6dc9adb6292d5a00000000000000000000000007ceb23fd6bc0add59e62ac25578270cff1b9f619b8800000000000000000000000000000000000000000000000000000000000000089000000000000000000179b616e0c082d7534e7cd4f488cc0cb89e815567b89590000000000000001000000000000000000000000000000000000000000000000fa7c8cfe325713673a86c50ef6296c76497d86f5829c1415f187b6ac20ff2707f903bd947598e84b2e114ab62cab288ce5f7d5f6bad35bbaf863a07bfffe4b1a7ee0d5ebb45f7d8b0eea0a4ddfa94221b2325b850e5a5925e5e970a00000000000000000000000002cad75e380ddb12329231df6793a0343917be8b3a000000000000000000000000088bac6a8ac61e8e2e83466c16a8a876abbeac757b90340fa7c8cfe325713673a86c50ef6296c76497d86f5829c1415f187b6ac20ff27070000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000002d5de0000000000000000000000002cad75e380ddb12329231df6793a0343917be8b300000000000000000000000075ba5af8effdcfca32e1e288806d54277d1fde9900000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000065721cd9000000000000000000000000000000000000000000000000000000006572205d000000000000000000000000000000000000000000000000000000000000020427be3c2400000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000ade09131c6f43fe22c2cbabb759636c43cfc181e0000000000000000000000007ceb23fd6bc0add59e62ac25578270cff1b9f6190000000000000000000000000000000000000000000000000000000000000089000000000000000000179b616e0c082d7534e7cd4f488cc0cb89e815567b89590000000000000001000000000000000000000000000000000000000000000000fa7c8cfe325713673a86c50ef6296c76497d86f5829c1415f187b6ac20ff2707000000000000000000000000000000000000000000000000000000000000008900000000000000000000000088483b3e3b4dd7cedb8efcef81f6dc9adb6292d500000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000084d9ef0bee00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f9013d940000000000000000000000000000000000001010f884a04dfe1bbbcf077ddc3e01291eea2d5c70c2b422b415d95645b9adcfd678cb1d63a00000000000000000000000000000000000000000000000000000000000001010a00000000000000000000000002cad75e380ddb12329231df6793a0343917be8b3a00000000000000000000000007c7379531b2aee82e4ca06d4175d13b9cbeafd49b8a0000000000000000000000000000000000000000000000000001b15357b964d680000000000000000000000000000000000000000000001c71f9cc30e427dd7db000000000000000000000000000000000000000000029719162863079c674dd40000000000000000000000000000000000000000000001c71f81add8c6e78a730000000000000000000000000000000000000000000297191643783d17fd9b3cb90f10f90f0df90131a02c058de84db4ef71bb941e2e5c5eca359365f6ea947e598ff9889ddc98579b09a0988b3401532fd001251abaa8acb0d314bfa31c240672f6a1015ef439716b274ca04419c2a871df8cd4701be6d6773e7ddf3614f15dd430a4d4c4b4ccede84cb6c7a08082b637cdb24defabfc9577b08d0cd3518d35e66aef535148ddd9625faa9649a07f48b23a69ac60c7d08036e67d305370940787316607809c5837e8053cb274f2a0bf470027e6318fc1cd0bb565f878cc88b2859df5b47bfda4d8273e2b0e62127ba06b9037cfbaba987d74c8b5131c1cdf1d03bf0b92526302eb7945c282e1b29556a0fdd6bff99530cc20780c2645494318a5bc6d6101e8da07755c926d0d8963673ea0aa2ec98ae431023b3d4f990d50d9f24f6f7197711c49d47e74a6544b27149c228080808080808080f871a0de47759bc2bdd56caf625c918f0cc5f4473725a7ce5a182f61f366a996006b3ba0340d8755b98eda2d86c6fd2ff95a278f748fc39f388bbde54a22ce87be6e8b55a055fff4246db279c11fbbfd9f9846bf5882ddaa41491e2bbfa4632f123f5e88d88080808080808080808080808080f901118080808080808080a005531853abf5522c47c058d772fc3662c52b9007d5be94b7f5868125857b776ca07a3c3b1c111cdf13c9fc88a6d6deb24ea3965936fca75e48da04ecef3197bb76a0e235401df329675c4c993fad89e74d5c40d021b742ff3d7f6428ea807c07d77ba0aa471a741f011e093f9ecfd18b3586edcb20a0905df02810beb8516ea3043456a04bd7d15957753057b5cd6c163d6548fe80694f8e6de358896fd930dfff2fbf19a0f9c0d59f8c39012670e22de9a54e908ca0fb8c95379a352bd75d8ca2a7efcd64a06010456aa50ac6e6d55805c037aa3f3640e674f430f1826175853805a1f72a6ba02dc0029f7ef1486b168326621c40e9872253f0bb46fca814e5b2f96529fe0d4980f90211a042ac71675f02e36b4ae9d94e63d759a1fc1f16f317c7a1124868dfb7267083b0a0ce99aef8bc1ee3f896f1bf4418f234ff2a816364963445001ce350002a0bfc71a0ff79631eea9d12cb13da2affdaafcaa904730e7f03c378df2afb56924d052438a08c3fdb2a5c9e2c0dbe4f09b152677c60dae65755c3efbb4403f9e03bd3803500a0ea25eadd0749ba5286dee6cb3f20f23be5cb6179f2e8784e28dc7f8697d85863a085878daec2565bbc4372f4688767afbd6c68717a510e94ed5943e24b04c436e8a0b8ac9ccd1f45de8ba9d1b1488f447528abacbbdbcfced06286722423db6219e2a000e621c25f6aa3483fafd90432a0b2292c91bd57b32fb7b438edce793d22982aa0973f454661cef260a07b59518d09fad3bed6f4be13828ae0e4c961211f315d2aa02d814a0d34dbab580bb9bc25bc7c1fb53cf7147243968a048193683786af0b0da05364d3ad11f0ac1f6d2d0e877664947dd1d1534155b5e986545106a9ece8158da0b05ded07bbe1b420bf9e0505ff0adda6d989a1f97aee8658d8e4b11e302e9c6ea0f3116530f3114aa8297e02fa449a5379d021548e50f7ec899d134dcda165979ba0e136080364f6be07e865afb0d4c67ef50b38d368ee928b2fc435c17e2e8a37bfa0d4ae860486bb13f3b43814757628d56a65bd7d6ab10a5d19cdbd48f051ca7160a0c8cc1c66d17bba9005e868938a83b881f6fc0448739c9b792cef97cdd6870c6f80f90a3b20b90a3702f90a3301838daca5b9010000004000000000000408000000000000000000000000400000000000000000412000000000000200000088002000000000008000000000000000000000000000000010000000000800000000000080800000000040400040000100000000000000000000040000001000040000000001000000100040000080000000000000000000000000400000000000040800000020400000000400000000000000000100204000000000080000800040800000000008000000000000000000000000004000000000000000080481000040000000040000000000000000100000001000000000000000000001000002800000000400000000000000000000000420104001f90928f8999496fddc1a6fbdb232e9ada1ffc1026799f85128e9e1a08c5261668696ce22758910d05bab8f186d6eb247ceac2af2e82c7dc17669b036b86000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020f13ac1d04c41ca8349344610c9a148a7d1a29be208282d5e98e56dfa99b38fdbf8f99496fddc1a6fbdb232e9ada1ffc1026799f85128e9e1a0dcaa37a042a0087de79018c629bbd29cee82ca80bd9be394e1696bf9e9355077b8c0000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000088483b3e3b4dd7cedb8efcef81f6dc9adb6292d50000000000000000000000000000000000000000000000000000000000000020f13ac1d04c41ca8349344610c9a148a7d1a29be208282d5e98e56dfa99b38fdb0000000000000000000000000000000000000000000000000000000000000000f8799488483b3e3b4dd7cedb8efcef81f6dc9adb6292d5e1a09826a73d0fd7186bda6a15195ac17571869cab151bfe9a8fed3f9407fffe5b18b84000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000923d663c88ce81fdb5f87a940970adeb473609f91d03e9bba85f49c445040cd7f842a03d0ce9bfc3ed7d6862dbb28b2dea94561fe714a1b4d019aa8af39730d1ad7c3da000000000000000000000000088483b3e3b4dd7cedb8efcef81f6dc9adb6292d5a00000000000000000000000000000000000000000000000000000000000000000f8799488483b3e3b4dd7cedb8efcef81f6dc9adb6292d5e1a09826a73d0fd7186bda6a15195ac17571869cab151bfe9a8fed3f9407fffe5b18b84000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000923d663c88ce81fdb5f9011d9475ba5af8effdcfca32e1e288806d54277d1fde99f884a0116bfd46451bbd23e7a5f5b7420b28e3d98d4c477f173da513aaaeac3c4baadaa0000000000000000000000000ade09131c6f43fe22c2cbabb759636c43cfc181ea000000000000000000000000088483b3e3b4dd7cedb8efcef81f6dc9adb6292d5a00000000000000000000000007ceb23fd6bc0add59e62ac25578270cff1b9f619b8800000000000000000000000000000000000000000000000000000000000000089000000000000000000179b616e0c082d7534e7cd4f488cc0cb89e815567b89590000000000000001000000000000000000000000000000000000000000000000fa7c8cfe325713673a86c50ef6296c76497d86f5829c1415f187b6ac20ff2707f903bd947598e84b2e114ab62cab288ce5f7d5f6bad35bbaf863a07bfffe4b1a7ee0d5ebb45f7d8b0eea0a4ddfa94221b2325b850e5a5925e5e970a00000000000000000000000002cad75e380ddb12329231df6793a0343917be8b3a000000000000000000000000088bac6a8ac61e8e2e83466c16a8a876abbeac757b90340fa7c8cfe325713673a86c50ef6296c76497d86f5829c1415f187b6ac20ff27070000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000002d5de0000000000000000000000002cad75e380ddb12329231df6793a0343917be8b300000000000000000000000075ba5af8effdcfca32e1e288806d54277d1fde9900000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000065721cd9000000000000000000000000000000000000000000000000000000006572205d000000000000000000000000000000000000000000000000000000000000020427be3c2400000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000ade09131c6f43fe22c2cbabb759636c43cfc181e0000000000000000000000007ceb23fd6bc0add59e62ac25578270cff1b9f6190000000000000000000000000000000000000000000000000000000000000089000000000000000000179b616e0c082d7534e7cd4f488cc0cb89e815567b89590000000000000001000000000000000000000000000000000000000000000000fa7c8cfe325713673a86c50ef6296c76497d86f5829c1415f187b6ac20ff2707000000000000000000000000000000000000000000000000000000000000008900000000000000000000000088483b3e3b4dd7cedb8efcef81f6dc9adb6292d500000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000084d9ef0bee00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f9013d940000000000000000000000000000000000001010f884a04dfe1bbbcf077ddc3e01291eea2d5c70c2b422b415d95645b9adcfd678cb1d63a00000000000000000000000000000000000000000000000000000000000001010a00000000000000000000000002cad75e380ddb12329231df6793a0343917be8b3a00000000000000000000000007c7379531b2aee82e4ca06d4175d13b9cbeafd49b8a0000000000000000000000000000000000000000000000000001b15357b964d680000000000000000000000000000000000000000000001c71f9cc30e427dd7db000000000000000000000000000000000000000000029719162863079c674dd40000000000000000000000000000000000000000000001c71f81add8c6e78a730000000000000000000000000000000000000000000297191643783d17fd9b3c830081bc80";

  bytes32 public constant headerRoot = 0xf1cc830a1abe74ed7eefc77489dd2ed6adee9ad08c8fd8c98449b65f3bdd808e;
  uint256 public constant startBlock = 50861222;
  uint256 public constant end = 50863525;
  uint256 public constant createdAt = 1701982919;
  address public constant proposer = address(0x67B94473D81D0cd00849D563C94d0432Ac988B49);
  uint256 public constant headerBlock = 546670000;
}

contract PolygonHubConnectorTest is ConnectorHelper {
  address _checkPointManager;

  function setUp() public {
    _l1Domain = 6648936;
    _l2Domain = 1886350457;
    _checkPointManager = address(new ICheckpointManagerTest());
    _l2Connector = payable(address(0x96fDDc1A6FBDb232e9adA1fFc1026799F85128e9));
    // deploy
    _l1Connector = payable(
      address(new PolygonHubConnectorTarget(_l1Domain, _l2Domain, _amb, _rootManager, _l2Connector, _checkPointManager))
    );
  }

  // ============ Utils ============
  function utils_setHubConnectorProcessMocks(address _sender) public {
    // 3. call to root manager
    vm.mockCall(_rootManager, abi.encodeWithSelector(IRootManager.aggregate.selector), abi.encode(true));
  }

  // ============ PolygonHubConnector.setFxChildTunnel ============

  function test_PolygonHubConnector__setMirrorConnector_shouldWork() public {
    // redeploy without setting mirror
    _l1Connector = payable(
      address(new PolygonHubConnectorTarget(_l1Domain, _l2Domain, _amb, _rootManager, address(0), _checkPointManager))
    );
    PolygonHubConnector(_l1Connector).setMirrorConnector(_l2Connector);
    assertEq(PolygonHubConnector(_l1Connector).fxChildTunnel(), _l2Connector);
    assertEq(PolygonHubConnector(_l1Connector).mirrorConnector(), _l2Connector);
  }

  function test_PolygonHubConnector__setFxChildTunnel_failedIfAlreadySet() public {
    _l2Connector = payable(address(2));
    vm.expectRevert(bytes("FxBaseRootTunnel: CHILD_TUNNEL_ALREADY_SET"));

    PolygonHubConnector(_l1Connector).setMirrorConnector(_l2Connector);
  }

  // ============ PolygonHubConnector.sendMessage ============
  function test_PolygonHubConnector__sendMessage_works() public {
    // setup mock
    vm.mockCall(_amb, abi.encodeWithSelector(IFxStateSender.sendMessageToChild.selector), abi.encode(123));

    // data
    bytes memory _data = abi.encode(123123123);

    // should emit an event
    vm.expectEmit(true, true, true, true);
    emit MessageSent(_data, bytes(""), _rootManager);

    // should call send contract transaction
    vm.expectCall(_amb, abi.encodeWithSelector(IFxStateSender.sendMessageToChild.selector, _l2Connector, _data));

    vm.prank(_rootManager);
    PolygonHubConnector(_l1Connector).sendMessage(_data, bytes(""));
  }

  function test_PolygonHubConnector__sendMessage_works_fuzz(bytes32 data) public {
    // setup mock
    vm.mockCall(_amb, abi.encodeWithSelector(IFxStateSender.sendMessageToChild.selector), abi.encode(123));

    // data
    bytes memory _data = abi.encode(data);

    // should emit an event
    vm.expectEmit(true, true, true, true);
    emit MessageSent(_data, bytes(""), _rootManager);

    // should call send contract transaction
    vm.expectCall(_amb, abi.encodeWithSelector(IFxStateSender.sendMessageToChild.selector, _l2Connector, _data));

    vm.prank(_rootManager);
    PolygonHubConnector(_l1Connector).sendMessage(_data, bytes(""));
  }

  // ============ PolygonHubConnector.receiveMessage ============
  function test_PolygonHubConnector__receiveMessage_works() public {
    // RLP encoded data from sample tx
    ICheckpointManagerTest(_checkPointManager).setHeaderBlocks(
      SampleTransaction.headerBlock,
      ICheckpointManager.HeaderBlock(
        SampleTransaction.headerRoot,
        SampleTransaction.startBlock,
        SampleTransaction.end,
        SampleTransaction.createdAt,
        SampleTransaction.proposer
      )
    );

    vm.mockCall(
      _rootManager,
      abi.encodeWithSelector(IRootManager.aggregate.selector, _l2Domain, SampleTransaction.root),
      abi.encode(true)
    );

    vm.expectCall(
      _rootManager,
      abi.encodeWithSelector(IRootManager.aggregate.selector, _l2Domain, SampleTransaction.root)
    );

    vm.expectEmit();
    emit MessageProcessed(abi.encode(SampleTransaction.root), address(this));

    // Call receiveMessage
    PolygonHubConnector(_l1Connector).receiveMessage(SampleTransaction.data);
  }

  function test_PolygonHubConnector__receiveMessage_failsOnDuplicate() public {
    PolygonHubConnectorTarget(_l1Connector).markAsProcessed(SampleTransaction.root);

    ICheckpointManagerTest(_checkPointManager).setHeaderBlocks(
      SampleTransaction.headerBlock,
      ICheckpointManager.HeaderBlock(
        SampleTransaction.headerRoot,
        SampleTransaction.startBlock,
        SampleTransaction.end,
        SampleTransaction.createdAt,
        SampleTransaction.proposer
      )
    );

    vm.expectRevert("message root already processed");
    // Call receiveMessage
    PolygonHubConnector(_l1Connector).receiveMessage(SampleTransaction.data);
  }
}
